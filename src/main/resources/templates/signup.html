<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{fragment/head :: Head ('KoSoo | íšŒì›ê°€ì… ë©¤ë²„')}"><title></title></head>
<body>
<div class="container-fluid">
    <div th:replace="~{fragment/nav :: Nav}">insert</div>
    <div class="text-center sub-title fs-4 fw-bold">íšŒì›ê°€ì… í˜ì´ì§€</div>

    <div class="container container-30">
        <!-- ê° í•­ëª©ì˜ ì…ë ¥ í™•ì¸ì„ ìœ„í•œ ìš”ì†Œ ì¶”ê°€ -->
        <div id="input-username" class="input-group mb-3">
            <label for="username" class="visually-hidden">ì•„ì´ë”” ì…ë ¥ë€</label>
            <input type="text" id="username" class="form-control p-2 is-invalid" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”." onblur="validateInput(this)">
        </div>
        <div id="input-password" class="input-group mb-3">
            <label for="password" class="visually-hidden">ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ë€</label>
            <input type="password" id="password" class="form-control p-2 is-invalid" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”." onblur="validateInput(this)">
        </div>
        <div id="input-email" class="input-group mb-3">
            <label for="email" class="visually-hidden">ì´ë©”ì¼ ì…ë ¥ë€</label>
            <input type="email" id="email" class="form-control p-2 is-invalid" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”." aria-label="sending auth-code" aria-describedby="button-addon2" onblur="validateInput(this)">
            <label for="button-addon2" class="visually-hidden">ì¸ì¦ ë²„íŠ¼</label>
            <button onclick="sendEmail()" type="button" id="button-addon2" class="btn btn-edit">ì¸ì¦</button>
        </div>
        <div id="input-code" class="input-group mb-3">
            <label for="code" class="visually-hidden">ì¸ì¦ì½”ë“œ ì…ë ¥ë€</label>
            <input type="text" id="code" class="form-control p-2 is-invalid" placeholder="ì´ë©”ì¼ ì¸ì¦ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”." onblur="validateInput(this)">
        </div>
        <div class="d-grid mb-5">
            <label for="btn" class="visually-hidden">íšŒì›ê°€ì… ë²„íŠ¼</label>
            <button id="btn" onclick="signup()" type="button" class="btn btn-submit p-2">íšŒì›ê°€ì…</button>
        </div>
        <!-- ì…ë ¥ í•„ë“œ ë¯¸ì…ë ¥ ì‹œ ê²½ê³  í‘œì‹œë¥¼ ìœ„í•œ ìš”ì†Œ ì¶”ê°€ -->
        <div id="input-error" class="alert alert-danger" style="display: none;">
            <svg class="bi flex-shrink-0 me-2" role="img" aria-label="Info:"><use xlink:href="#info-fill"/></svg>
            <div>
                ëª¨ë“  ì¹¸ì„ ì…ë ¥ í•´ì£¼ì„¸ìš”!
            </div>
        </div>
        <!-- íšŒì›ê°€ì… ì„±ê³µ ë©”ì‹œì§€ë¥¼ ìœ„í•œ ìš”ì†Œ ì¶”ê°€ -->
        <div id="signup-success" class="alert alert-success" style="display: none;">
            <svg class="bi flex-shrink-0 me-2" role="img" aria-label="Success:"><use xlink:href="#check-circle-fill"/></svg>
            <div>
                íšŒì›ê°€ì…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
            </div>
        </div>
    </div>
</div>
</body>
<script>
    let code = '';
    const host = 'http://' + window.location.host;

    function sendEmail() {
        let email = $('#email').val();
        $.ajax({
            type: 'POST',
            url: '/api/accounts/email-auth',
            contentType: 'application/json',
            data: JSON.stringify({ email: email }),
        }).done(function (res) {
            console.log(res);
            code = res;
        }).fail(function (res) {
            alert(res.responseText);
        });
    }

    function signup() {
        let username = $('#username').val();
        let password = $('#password').val();
        let email = $('#email').val();
        let inputCode = $('#code').val();

        // ì˜ˆì™¸ ì²˜ë¦¬: ëª¨ë“  í•„ë“œê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ì„ ê²½ìš°
        if (!username || !password || !email || !inputCode) {
            const errorDiv = document.getElementById('input-error');
            errorDiv.style.display = 'block';
            errorDiv.textContent = 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
            return;
        }

        if (inputCode === code) {
            $.ajax({
                type: 'POST',
                url: '/api/accounts/signup',
                contentType: 'application/json',
                data: JSON.stringify({ username: username, password: password, email: email }),
            }).done(function () {
                const successDiv = document.getElementById('signup-success');
                successDiv.style.display = 'block';
                setTimeout(function() {
                    window.location.href = host;
                }, 2000); // 5ì´ˆ í›„ì— ë¦¬ë‹¤ì´ë ‰íŠ¸
            }).fail(function (res) {
                alert(res.responseText);
            });
        } else {
            alert('ğŸ˜¨ ì¸ì¦ì½”ë“œ ë¶ˆì¼ì¹˜');
        }
    }

    // ì…ë ¥ í•„ë“œì˜ ê°’ì„ ê²€ì‚¬í•˜ê³  ë¹„ì–´ ìˆìœ¼ë©´ ê²½ê³  ìŠ¤íƒ€ì¼ì„ ì ìš©
    function validateInput(input) {
        const value = input.value.trim();
        if (!value) {
            input.classList.add('is-invalid');
        } else {
            input.classList.remove('is-invalid');
        }
    }
</script>
</html>
